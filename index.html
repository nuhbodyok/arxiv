<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArXiv Paper Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-4 transition-colors duration-200">
    <div class="container mx-auto max-w-4xl">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-bold text-center text-gray-800 dark:text-white">ArXiv Paper Search</h1>
            <button id="theme-toggle" class="p-2 text-gray-500 dark:text-gray-300">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
        </div>
        
        <!-- Simple Search Form -->
        <div class="bg-white dark:bg-gray-800 p-3 rounded shadow-sm mb-3">
            <div class="flex flex-col md:flex-row gap-2">
                <div class="flex-grow">
                    <input type="text" id="search-input" placeholder="Search for papers" 
                           class="w-full p-1.5 border rounded text-base dark:bg-gray-700 dark:text-white dark:border-gray-600">
                </div>
                <div class="w-full md:w-32">
                    <select id="results-count" class="w-full p-1.5 border rounded text-base dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="10">10 results</option>
                        <option value="20">20 results</option>
                        <option value="50">50 results</option>
                        <option value="100">100 results</option>
                        <option value="500">500 results</option>
                        <option value="1000">Maximum results</option>
                    </select>
                </div>
                <div>
                    <button id="search-button" class="w-full md:w-auto bg-primary text-white px-3 py-1.5 rounded text-sm">
                        <i class="fas fa-search mr-1"></i> Search
                    </button>
                </div>
            </div>
            
            <!-- Search History Dropdown -->
            <div id="search-history-container" class="mt-2 hidden">
                <div class="text-xs text-gray-500 dark:text-gray-400 mb-1 flex justify-between items-center">
                    <span>Recent searches</span>
                    <button id="clear-history" class="text-xs text-primary">Clear</button>
                </div>
                <div id="search-history" class="text-sm space-y-1 max-h-32 overflow-y-auto"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex mb-4 border-b dark:border-gray-700">
            <button id="results-tab" class="py-2 px-4 border-b-2 border-primary text-primary dark:text-white">Results</button>
            <button id="library-tab" class="py-2 px-4 border-b-2 border-transparent dark:text-gray-300">Library (<span id="saved-count">0</span>)</button>
        </div>
        
        <!-- Results Section -->
        <div id="results-section">
            <div id="loading" class="hidden flex justify-center p-10">
                <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div id="search-message" class="text-center p-10 text-gray-500 dark:text-gray-400">
                Enter your search terms and press Search to find papers
            </div>
            <div id="results-info" class="text-sm text-gray-600 dark:text-gray-400 mb-2 hidden">
                <span id="results-count-display"></span>
            </div>
            <div id="save-all-container" class="hidden mb-3 flex justify-end">
                <button id="save-all-btn" class="bg-primary text-white px-3 py-1 rounded text-sm">
                    <i class="fas fa-star mr-1"></i> Save All Results
                </button>
            </div>
            <div id="search-results" class="space-y-1.5"></div>
        </div>
        
        <!-- Library Section -->
        <div id="library-section" class="hidden">
            <div class="flex justify-between mb-2">
                <h2 class="text-lg font-bold dark:text-white">Saved Papers</h2>
                <div class="flex gap-2">
                    <select id="export-format" class="text-sm p-1 border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600">
                        <option value="csv">CSV Format</option>
                        <option value="bibtex">BibTeX Format</option>
                    </select>
                    <button id="export-btn" class="bg-primary text-white px-3 py-1 text-sm rounded" disabled>
                        <i class="fas fa-file-export mr-1"></i> Export
                    </button>
                </div>
            </div>
            <div id="library-empty" class="text-center p-4 text-gray-500 dark:text-gray-400 text-sm">
                Your library is empty
            </div>
            <div id="library-items" class="space-y-2"></div>
        </div>
    </div>

    <script>
        // State management
        let savedPapers = [];
        let searchResults = [];
        let searchHistory = [];
        const MAX_HISTORY_ITEMS = 5;
        
        // DOM Elements
        const searchInput = document.getElementById('search-input');
        const resultsCount = document.getElementById('results-count');
        const searchButton = document.getElementById('search-button');
        const resultsTab = document.getElementById('results-tab');
        const libraryTab = document.getElementById('library-tab');
        const resultsSection = document.getElementById('results-section');
        const librarySection = document.getElementById('library-section');
        const loading = document.getElementById('loading');
        const searchMessage = document.getElementById('search-message');
        const searchResultsElement = document.getElementById('search-results');
        const savedCount = document.getElementById('saved-count');
        const libraryEmpty = document.getElementById('library-empty');
        const libraryItems = document.getElementById('library-items');
        const saveAllBtn = document.getElementById('save-all-btn');
        const saveAllContainer = document.getElementById('save-all-container');
        const exportBtn = document.getElementById('export-btn');
        const exportFormat = document.getElementById('export-format');
        const resultsInfo = document.getElementById('results-info');
        const resultsCountDisplay = document.getElementById('results-count-display');
        const themeToggle = document.getElementById('theme-toggle');
        const searchHistoryContainer = document.getElementById('search-history-container');
        const searchHistoryElement = document.getElementById('search-history');
        const clearHistoryBtn = document.getElementById('clear-history');
        
        // Dark mode detection and toggle
        function initTheme() {
            if (localStorage.getItem('dark-mode') === 'true' || 
                (localStorage.getItem('dark-mode') === null && 
                window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('dark-mode', document.documentElement.classList.contains('dark'));
        });
        
        // Initialize theme on load
        initTheme();
        
        // Load saved papers from localStorage
        function loadSavedPapers() {
            const saved = localStorage.getItem('arxiv-saved-papers');
            if (saved) {
                try {
                    savedPapers = JSON.parse(saved);
                    savedCount.textContent = savedPapers.length;
                    exportBtn.disabled = savedPapers.length === 0;
                } catch (e) {
                    console.error('Error loading saved papers:', e);
                    savedPapers = [];
                }
            }
        }
        
        // Save papers to localStorage
        function savePapersToStorage() {
            localStorage.setItem('arxiv-saved-papers', JSON.stringify(savedPapers));
            savedCount.textContent = savedPapers.length;
            exportBtn.disabled = savedPapers.length === 0;
        }
        
        // Load search history from localStorage
        function loadSearchHistory() {
            const history = localStorage.getItem('arxiv-search-history');
            if (history) {
                try {
                    searchHistory = JSON.parse(history);
                    updateSearchHistoryUI();
                } catch (e) {
                    console.error('Error loading search history:', e);
                    searchHistory = [];
                }
            }
        }
        
        // Save search history to localStorage
        function saveSearchHistory() {
            localStorage.setItem('arxiv-search-history', JSON.stringify(searchHistory));
            updateSearchHistoryUI();
        }
        
        // Update search history UI
        function updateSearchHistoryUI() {
            if (searchHistory.length > 0) {
                searchHistoryContainer.classList.remove('hidden');
                searchHistoryElement.innerHTML = '';
                
                searchHistory.forEach(query => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-1 rounded';
                    historyItem.textContent = query;
                    historyItem.addEventListener('click', () => {
                        searchInput.value = query;
                        searchHistoryContainer.classList.add('hidden');
                    });
                    searchHistoryElement.appendChild(historyItem);
                });
            } else {
                searchHistoryContainer.classList.add('hidden');
            }
        }
        
        // Add to search history
        function addToSearchHistory(query) {
            // Remove if exists already (to bring to top)
            searchHistory = searchHistory.filter(item => item !== query);
            
            // Add to beginning
            searchHistory.unshift(query);
            
            // Limit history size
            if (searchHistory.length > MAX_HISTORY_ITEMS) {
                searchHistory = searchHistory.slice(0, MAX_HISTORY_ITEMS);
            }
            
            saveSearchHistory();
        }
        
        // Clear search history
        clearHistoryBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            searchHistory = [];
            saveSearchHistory();
            searchHistoryContainer.classList.add('hidden');
        });
        
        // Show search history when input is focused
        searchInput.addEventListener('focus', () => {
            if (searchHistory.length > 0) {
                searchHistoryContainer.classList.remove('hidden');
            }
        });
        
        // Hide search history when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchHistoryContainer.contains(e.target) && e.target !== searchInput) {
                searchHistoryContainer.classList.add('hidden');
            }
        });
        
        // Tab switching
        resultsTab.addEventListener('click', () => {
            resultsTab.classList.add('border-primary', 'text-primary');
            libraryTab.classList.remove('border-primary', 'text-primary');
            resultsSection.classList.remove('hidden');
            librarySection.classList.add('hidden');
        });
        
        libraryTab.addEventListener('click', () => {
            libraryTab.classList.add('border-primary', 'text-primary');
            resultsTab.classList.remove('border-primary', 'text-primary');
            librarySection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            renderLibrary();
        });
        
        // Allow Enter key to search
        searchInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                searchButton.click();
            }
        });
        
        // Extract more detailed information from ArXiv entry
        function extractPaperDetails(entry) {
            const id = entry.getElementsByTagName('id')[0]?.textContent || '';
            const arxivId = id.split('/').pop();
            const title = entry.getElementsByTagName('title')[0]?.textContent || 'No title';
            const summary = entry.getElementsByTagName('summary')[0]?.textContent || '';
            const published = entry.getElementsByTagName('published')[0]?.textContent || '';
            const updated = entry.getElementsByTagName('updated')[0]?.textContent || '';
            
            // Extract authors
            const authorElements = entry.getElementsByTagName('author');
            const authors = Array.from(authorElements).map(author => {
                return author.getElementsByTagName('name')[0]?.textContent || '';
            });
            
            // Extract categories
            const categories = [];
            const categoryElements = entry.getElementsByTagName('category');
            for (let i = 0; i < categoryElements.length; i++) {
                const term = categoryElements[i].getAttribute('term');
                if (term) categories.push(term);
            }
            
            // Format date for display
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString();
                } catch (e) {
                    return dateStr;
                }
            };
            
            return {
                id: arxivId,
                title: title,
                link: `https://arxiv.org/abs/${arxivId}`,
                pdfLink: `https://arxiv.org/pdf/${arxivId}.pdf`,
                summary: summary,
                published: formatDate(published),
                updated: formatDate(updated),
                authors: authors,
                categories: categories,
                authorsStr: authors.join(', '),
                categoriesStr: categories.join(', ')
            };
        }
        
        // Search function with pagination
        searchButton.addEventListener('click', async () => {
            const query = searchInput.value.trim();
            if (!query) {
                // Show error message instead of alert
                searchMessage.textContent = 'Please enter search terms';
                searchMessage.classList.remove('hidden');
                return;
            }
            
            // Add to search history
            addToSearchHistory(query);
            
            try {
                // Show loading state
                loading.classList.remove('hidden');
                searchMessage.classList.add('hidden');
                searchResultsElement.innerHTML = '';
                resultsInfo.classList.add('hidden');
                
                // Get requested number of results
                const requestedResults = parseInt(resultsCount.value);
                
                // ArXiv API has a maximum of 100 results per request
                // We need to paginate to get more results
                const BATCH_SIZE = 100;
                const batchesToFetch = Math.ceil(Math.min(requestedResults, 1000) / BATCH_SIZE);
                
                searchResults = [];
                const uniqueIds = new Set(); // Track unique IDs to prevent duplicates
                
                // Status message during pagination
                const updateLoadingStatus = (current, total) => {
                    loading.innerHTML = `
                        <div class="flex flex-col items-center">
                            <div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin mb-2"></div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Fetching results (${current}/${total} batches)</div>
                        </div>
                    `;
                };
                
                // Process each batch of entries
                const processEntries = (entries) => {
                    Array.from(entries).forEach(entry => {
                        const paperDetails = extractPaperDetails(entry);
                        
                        // Skip duplicates
                        if (uniqueIds.has(paperDetails.id)) return;
                        uniqueIds.add(paperDetails.id);
                        
                        searchResults.push(paperDetails);
                        
                        // Stop if we've reached the requested number of results
                        if (searchResults.length >= requestedResults) {
                            return;
                        }
                    });
                };
                
                let hasResults = false;
                
                // Fetch results in batches
                for (let i = 0; i < batchesToFetch; i++) {
                    // Update status
                    updateLoadingStatus(i + 1, batchesToFetch);
                    
                    // Create ArXiv API URL with pagination
                    const start = i * BATCH_SIZE;
                    const url = `https://export.arxiv.org/api/query?search_query=all:${encodeURIComponent(query)}&start=${start}&max_results=${BATCH_SIZE}`;
                    
                    try {
                        // Fetch results
                        const response = await fetch(url);
                        
                        if (!response.ok) {
                            throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.text();
                        
                        // Parse XML
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(data, 'text/xml');
                        
                        // Check for parser errors
                        const parserError = xmlDoc.getElementsByTagName('parsererror');
                        if (parserError.length > 0) {
                            throw new Error('Failed to parse ArXiv API response');
                        }
                        
                        const entries = xmlDoc.getElementsByTagName('entry');
                        
                        if (entries.length > 0) {
                            hasResults = true;
                            processEntries(entries);
                        }
                        
                        // Stop if we've reached the requested number of results or if we got fewer results than batch size
                        if (searchResults.length >= requestedResults || entries.length < BATCH_SIZE) {
                            break;
                        }
                        
                        // Small delay to avoid hammering the API
                        await new Promise(resolve => setTimeout(resolve, 300));
                    } catch (error) {
                        console.error(`Error fetching batch ${i+1}:`, error);
                        // Continue with next batch instead of breaking completely
                    }
                }
                
                if (!hasResults) {
                    searchMessage.textContent = 'No results found. Try different search terms.';
                    searchMessage.classList.remove('hidden');
                    saveAllContainer.classList.add('hidden');
                } else {
                    renderSearchResults();
                    saveAllContainer.classList.remove('hidden');
                    
                    // Show total results count
                    resultsCountDisplay.textContent = `Found ${searchResults.length} results`;
                    resultsInfo.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Search error:', error);
                searchMessage.textContent = `Error: ${error.message || 'Failed to fetch papers. Please try again.'}`;
                searchMessage.classList.remove('hidden');
                saveAllContainer.classList.add('hidden');
            } finally {
                // Reset loading spinner to original state
                loading.innerHTML = '<div class="w-10 h-10 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>';
                loading.classList.add('hidden');
            }
        });
        
        // Render search results
        function renderSearchResults() {
            searchResultsElement.innerHTML = '';
            
            searchResults.forEach(paper => {
                const isSaved = savedPapers.some(p => p.id === paper.id);
                
                const paperElement = document.createElement('div');
                paperElement.className = 'bg-white dark:bg-gray-800 p-2 rounded shadow-sm text-sm';
                
                // Create collapsible section for paper details
                const detailsId = `details-${paper.id}`;
                
                paperElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="truncate flex-grow">
                            <span class="font-medium dark:text-white">${paper.title}</span>
                        </div>
                        <div class="flex items-center ml-2 flex-shrink-0 space-x-1">
                            <button class="details-toggle text-primary" data-target="${detailsId}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <a href="${paper.link}" target="_blank" class="text-primary hover:underline ml-1" title="View on arXiv">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <a href="${paper.pdfLink}" target="_blank" class="text-primary hover:underline ml-1" title="PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <button class="save-button ml-1 ${isSaved ? 'text-yellow-500' : 'text-gray-400 dark:text-gray-500'}" data-id="${paper.id}" title="${isSaved ? 'Remove from library' : 'Save to library'}">
                                <i class="fas fa-star"></i>
                            </button>
                        </div>
                    </div>
                    <div id="${detailsId}" class="mt-2 hidden">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Authors:</span> ${paper.authorsStr || 'N/A'}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Published:</span> ${paper.published || 'N/A'} 
                            ${paper.updated && paper.updated !== paper.published ? `<span class="font-semibold ml-2">Updated:</span> ${paper.updated}` : ''}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Categories:</span> ${paper.categoriesStr || 'N/A'}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-2 border-t pt-1 dark:border-gray-700">
                            <div class="font-semibold mb-1">Abstract:</div>
                            <p class="whitespace-pre-line">${paper.summary || 'No abstract available'}</p>
                        </div>
                    </div>
                `;
                
                searchResultsElement.appendChild(paperElement);
                
                // Add save button functionality
                const saveButton = paperElement.querySelector('.save-button');
                saveButton.addEventListener('click', () => {
                    toggleSavePaper(paper, saveButton);
                });
                
                // Add details toggle functionality
                const detailsToggle = paperElement.querySelector('.details-toggle');
                const detailsSection = paperElement.querySelector(`#${detailsId}`);
                
                detailsToggle.addEventListener('click', () => {
                    const isHidden = detailsSection.classList.contains('hidden');
                    
                    // Toggle icon and visibility
                    if (isHidden) {
                        detailsSection.classList.remove('hidden');
                        detailsToggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    } else {
                        detailsSection.classList.add('hidden');
                        detailsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    }
                });
            });
        }
        
        // Toggle save/unsave paper
        function toggleSavePaper(paper, button) {
            const index = savedPapers.findIndex(p => p.id === paper.id);
            
            if (index === -1) {
                // Add to saved
                savedPapers.push(paper);
                button.classList.remove('text-gray-400', 'dark:text-gray-500');
                button.classList.add('text-yellow-500');
                button.title = 'Remove from library';
            } else {
                // Remove from saved
                savedPapers.splice(index, 1);
                button.classList.add('text-gray-400', 'dark:text-gray-500');
                button.classList.remove('text-yellow-500');
                button.title = 'Save to library';
            }
            
            // Update saved count
            savePapersToStorage();
        }
        
        // Save all results
        saveAllBtn.addEventListener('click', () => {
            let added = 0;
            
            searchResults.forEach(paper => {
                if (!savedPapers.some(p => p.id === paper.id)) {
                    savedPapers.push(paper);
                    added++;
                    
                    // Update save button appearance
                    const saveButton = document.querySelector(`.save-button[data-id="${paper.id}"]`);
                    if (saveButton) {
                        saveButton.classList.remove('text-gray-400', 'dark:text-gray-500');
                        saveButton.classList.add('text-yellow-500');
                    }
                }
            });
            
            // Update saved count
            savePapersToStorage();
            
            if (added > 0) {
                // Show message without alert
                const messageElement = document.createElement('div');
                messageElement.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg';
                messageElement.textContent = `Added ${added} papers to your library`;
                document.body.appendChild(messageElement);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(messageElement);
                }, 3000);
            }
        });
        
        // Render library
        function renderLibrary() {
            if (savedPapers.length === 0) {
                libraryEmpty.classList.remove('hidden');
                libraryItems.classList.add('hidden');
                exportBtn.disabled = true;
                return;
            }
            
            libraryEmpty.classList.add('hidden');
            libraryItems.classList.remove('hidden');
            exportBtn.disabled = false;
            
            libraryItems.innerHTML = '';
            
            savedPapers.forEach(paper => {
                const paperElement = document.createElement('div');
                paperElement.className = 'bg-white dark:bg-gray-800 p-2 rounded shadow-sm text-sm';
                
                // Create collapsible section for paper details
                const detailsId = `library-details-${paper.id}`;
                
                paperElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="truncate flex-grow">
                            <span class="font-medium dark:text-white">${paper.title}</span>
                        </div>
                        <div class="flex items-center ml-2 flex-shrink-0 space-x-1">
                            <button class="details-toggle text-primary" data-target="${detailsId}">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <a href="${paper.link}" target="_blank" class="text-primary hover:underline ml-1" title="View on arXiv">
                                <i class="fas fa-external-link-alt"></i>
                            </a>
                            <a href="${paper.pdfLink}" target="_blank" class="text-primary hover:underline ml-1" title="PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <button class="remove-button ml-1 text-red-500" data-id="${paper.id}" title="Remove from library">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="${detailsId}" class="mt-2 hidden">
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Authors:</span> ${paper.authorsStr || 'N/A'}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Published:</span> ${paper.published || 'N/A'} 
                            ${paper.updated && paper.updated !== paper.published ? `<span class="font-semibold ml-2">Updated:</span> ${paper.updated}` : ''}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mb-1">
                            <span class="font-semibold">Categories:</span> ${paper.categoriesStr || 'N/A'}
                        </div>
                        <div class="text-xs text-gray-600 dark:text-gray-400 mt-2 border-t pt-1 dark:border-gray-700">
                            <div class="font-semibold mb-1">Abstract:</div>
                            <p class="whitespace-pre-line">${paper.summary || 'No abstract available'}</p>
                        </div>
                    </div>
                `;
                
                libraryItems.appendChild(paperElement);
                
                // Add remove button functionality
                const removeButton = paperElement.querySelector('.remove-button');
                removeButton.addEventListener('click', () => {
                    const index = savedPapers.findIndex(p => p.id === paper.id);
                    if (index !== -1) {
                        savedPapers.splice(index, 1);
                        savePapersToStorage();
                        renderLibrary();
                        
                        // Update button in search results if visible
                        const saveButton = document.querySelector(`.save-button[data-id="${paper.id}"]`);
                        if (saveButton) {
                            saveButton.classList.add('text-gray-400', 'dark:text-gray-500');
                            saveButton.classList.remove('text-yellow-500');
                        }
                    }
                });
                
                // Add details toggle functionality
                const detailsToggle = paperElement.querySelector('.details-toggle');
                const detailsSection = paperElement.querySelector(`#${detailsId}`);
                
                detailsToggle.addEventListener('click', () => {
                    const isHidden = detailsSection.classList.contains('hidden');
                    
                    // Toggle icon and visibility
                    if (isHidden) {
                        detailsSection.classList.remove('hidden');
                        detailsToggle.innerHTML = '<i class="fas fa-chevron-up"></i>';
                    } else {
                        detailsSection.classList.add('hidden');
                        detailsToggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                    }
                });
            });
        }
        
        // Generate BibTeX citation
        function generateBibTeX(paper) {
            const cleanAuthors = paper.authors.map(author => {
                // Replace special characters and return last name first
                const parts = author.split(' ');
                if (parts.length > 1) {
                    const lastName = parts.pop();
                    return `${lastName}, ${parts.join(' ')}`;
                }
                return author;
            }).join(' and ');
            
            // Generate a citation key: first author's last name + year + first word of title
            let citationKey = '';
            if (paper.authors.length > 0) {
                const firstAuthor = paper.authors[0].split(' ').pop();
                const year = paper.published ? paper.published.split('/').pop() : '';
                const firstWord = paper.title.split(' ')[0].replace(/[^\w]/g, '');
                citationKey = `${firstAuthor}${year}${firstWord}`;
            } else {
                citationKey = `arxiv${paper.id.replace('.', '')}`;
            }
            
            // Escape special characters in title
            const escapedTitle = paper.title
                .replace(/{/g, '\\{')
                .replace(/}/g, '\\}')
                .replace(/_/g, '\\_')
                .replace(/&/g, '\\&')
                .replace(/#/g, '\\#')
                .replace(/\$/g, '\\$')
                .replace(/%/g, '\\%')
                .replace(/\^/g, '\\^')
                .replace(/~/g, '\\~');
            
            return `@article{${citationKey},
  title={${escapedTitle}},
  author={${cleanAuthors}},
  journal={arXiv preprint arXiv:${paper.id}},
  url={${paper.link}},
  pdf={${paper.pdfLink}},
  year={${paper.published ? paper.published.split('/').pop() : 'n/a'}}
}`;
        }
        
        // Export functionality
        exportBtn.addEventListener('click', () => {
            if (savedPapers.length === 0) return;
            
            let content = '';
            const format = exportFormat.value;
            
            if (format === 'csv') {
                // Create CSV format with more details
                content = 'Title,Authors,Published,Updated,Categories,ArXiv ID,URL,PDF URL\n';
                
                savedPapers.forEach(paper => {
                    // Properly escape fields for CSV
                    const escapeCsv = (str) => `"${(str || '').replace(/"/g, '""')}"`;
                    
                    content += [
                        escapeCsv(paper.title),
                        escapeCsv(paper.authorsStr),
                        escapeCsv(paper.published),
                        escapeCsv(paper.updated),
                        escapeCsv(paper.categoriesStr),
                        escapeCsv(paper.id),
                        paper.link,
                        paper.pdfLink
                    ].join(',') + '\n';
                });
            } else if (format === 'bibtex') {
                // Create BibTeX format
                content = savedPapers.map(generateBibTeX).join('\n\n');
            }
            
            // Create modal for displaying export
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded max-w-2xl w-full p-4 max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold dark:text-white">Exported Papers (${format.toUpperCase()})</h2>
                        <button id="close-modal" class="text-gray-600 dark:text-gray-400">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-sm dark:text-gray-300">
                            ${format === 'csv' ? 'CSV format for spreadsheet import' : 'BibTeX format for LaTeX documents'}
                        </p>
                        <button id="copy-button" class="bg-primary text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-copy mr-1"></i> Copy to Clipboard
                        </button>
                    </div>
                    <pre class="bg-gray-100 dark:bg-gray-900 p-4 rounded text-sm overflow-auto whitespace-pre-wrap dark:text-gray-300">${content}</pre>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal functionality
            const closeButton = modal.querySelector('#close-modal');
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            // Click outside to close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // Copy to clipboard functionality
            const copyButton = modal.querySelector('#copy-button');
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(content)
                    .then(() => {
                        copyButton.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
                        setTimeout(() => {
                            copyButton.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy to Clipboard';
                        }, 2000);
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        copyButton.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i> Failed to copy';
                        setTimeout(() => {
                            copyButton.innerHTML = '<i class="fas fa-copy mr-1"></i> Copy to Clipboard';
                        }, 2000);
                    });
            });
        });
        
        // Load saved papers on page load
        loadSavedPapers();
        
        // Load search history on page load
        loadSearchHistory();
    </script>
</body>
</html>
